var page,url=location.href.split("?")[0],title=!1,importing=!1;function exportPlay(){let e=[];e.push(document.querySelector('div[class="dynamic-text-container style-scope yt-dynamic-sizing-formatted-string"]').querySelector("yt-formatted-string").innerHTML);let t=document.querySelectorAll('a[id="video-title"]');for(let l of t)l.href=l.href.split("&list=")[0],e.push(title?l.title+","+l.href:l.href);let r=e.join("\n"),i=new Blob([r],{type:"text/csv"}),s=window.document.createElement("a");s.href=window.URL.createObjectURL(i),s.download=e[0].replace(/\s/g,"")+".csv",document.body.appendChild(s),s.click(),document.body.removeChild(s)}function waitForElm(e){return new Promise(t=>{if(document.querySelector(e))return t(document.querySelector(e));let l=new MutationObserver(r=>{document.querySelector(e)&&(l.disconnect(),t(document.querySelector(e)))});l.observe(document.body,{childList:!0,subtree:!0})})}function timeout(e){return new Promise(t=>{setTimeout(t,e)})}async function savePlaylist(e){(await waitForElm("[aria-label='Save to playlist']")).click(),await waitForElm("ytd-add-to-playlist-create-renderer"),document.querySelectorAll('button[aria-label="Create"')[1];let t=document.getElementsByClassName("tp-yt-paper-input")[3],l=document.querySelector(`yt-formatted-string[title='${e}']`);if(null!=l){let r=l.parentElement.parentElement.parentElement.parentElement,i=r.checked;if(void 0===i&&void 0===(i=r.getAttribute("aria-checked"))){let s=new Promise(e=>{let t=new MutationObserver(l=>{let i=r.getAttribute("aria-checked");void 0!=i&&(t.disconnect(),e(i))});t.observe(r,{attributes:!0})});i=await s}if("false"==i)l.click();else if("true"==i){chrome.runtime.sendMessage({type:"finishimport"});return}else{console.error(`ERROR: ${i} of type ${typeof i} not recognized`);return}}else{await waitForElm('ytd-compact-link-renderer[class="style-scope ytd-add-to-playlist-create-renderer"]');document.getElementsByClassName("ytd-add-to-playlist-create-renderer")[0].click(),t.value=e,t.parentElement.dispatchEvent(new Event("input")),document.querySelectorAll('ytd-button-renderer[class="style-scope ytd-add-to-playlist-create-renderer"]')[1].click()}let n=new MutationObserver(e=>{let t=document.querySelectorAll("tp-yt-paper-toast");for(let l=0;l<t.length;l++)t[l].children[1].firstElementChild.firstElementChild&&("Saved to "===t[l].children[1].firstElementChild.firstElementChild.innerHTML||"Added to "===t[l].children[1].firstElementChild.firstElementChild.innerHTML)&&(chrome.runtime.sendMessage({type:"finishimport"}),n.disconnect())});n.observe(document.querySelector("ytd-popup-container"),{childList:!0,subtree:!0})}function injectplaylist(e){!document.getElementById("scrollb")&&waitForElm('div[class="metadata-buttons-wrapper style-scope ytd-playlist-header-renderer"]').then(()=>{function e(){if(null===document.querySelector('div[id="contents"][class=" style-scope ytd-playlist-video-list-renderer style-scope ytd-playlist-video-list-renderer"]').querySelector("ytd-continuation-item-renderer"))exportPlay(),r.click();else{document.querySelector('div[id="contents"][class=" style-scope ytd-playlist-video-list-renderer style-scope ytd-playlist-video-list-renderer"]').querySelector("ytd-continuation-item-renderer").scrollIntoView();let t=new MutationObserver(e=>{null===document.querySelector('div[id="contents"][class=" style-scope ytd-playlist-video-list-renderer style-scope ytd-playlist-video-list-renderer"]').querySelector("ytd-continuation-item-renderer")?(t.disconnect(),"true"==r.getAttribute("auto")&&exportPlay(),r.click()):document.querySelector('div[id="contents"][class=" style-scope ytd-playlist-video-list-renderer style-scope ytd-playlist-video-list-renderer"]').querySelector("ytd-continuation-item-renderer").scrollIntoView()});t.observe(document.querySelector('div[id="contents"][class=" style-scope ytd-playlist-video-list-renderer style-scope ytd-playlist-video-list-renderer"]'),{childList:!0,subtree:!0}),r.addEventListener("click",()=>{t.disconnect(),r.addEventListener("click",e,{once:!0}),r.setAttribute("scroll",!1)},{once:!0}),r.setAttribute("scroll",!0)}}let t=document.querySelector('div[class="metadata-buttons-wrapper style-scope ytd-playlist-header-renderer"]'),l=t.querySelector("ytd-menu-renderer"),r=document.createElement("button");r.className="yt-spec-button-shape-next yt-spec-button-shape-next--tonal yt-spec-button-shape-next--overlay yt-spec-button-shape-next--size-m yt-spec-button-shape-next--icon-button",r.id="scrollb",r.setAttribute("auto",!0),r.addEventListener("click",e,{once:!0});let i=document.createElement("ytd-button-renderer");i.className="style-scope ytd-playlist-header-renderer",t.insertBefore(i,l);i.querySelector("yt-button-shape").appendChild(r);i.querySelector("tp-yt-paper-tooltip").innerHTML='<div id="tooltip" class="style-scope tp-yt-paper-tooltip hidden" style-target="tooltip">Export</div>';let s=document.createElement("div");s.className="yt-spec-button-shape-next__icon";let n=document.createElement("yt-icon"),o=document.createElement("yt-icon-shape");o.className="style-scope yt-icon",r.appendChild(s),s.appendChild(n),n.appendChild(o),o.innerHTML='<icon-shape class="yt-spec-icon-shape"><div style="width: 100%; height: 100%; fill: currentcolor;"><svg width="24" height="24" viewBox="0 0 30 30" xmlns="http://www.w3.org/2000/svg" focusable="false" style="pointer-events: none; display: block; width: 100%; height: 100%;"><path d="M16,1A15,15,0,1,0,31,16,15.007,15.007,0,0,0,16,1Zm0,2A13,13,0,1,1,3,16,13.006,13.006,0,0,1,16,3Z" transform="translate(-1 -1)" fill-rule="evenodd"/><path d="M21.293,12.293,16,17.586l-5.293-5.293a1,1,0,0,0-1.414,1.414l6,6a1,1,0,0,0,1.414,0l6-6a1,1,0,1,0-1.414-1.414Z" transform="translate(-1 -1)" fill - rule="evenodd"/></svg></div></icon-shape>';let a=new MutationObserver(e=>{"true"==r.getAttribute("scroll")&&r.click(),start()});a.observe(document.querySelector('div[class="dynamic-text-container style-scope yt-dynamic-sizing-formatted-string"]').querySelector("yt-formatted-string"),{childList:!0,subtree:!0})})}function start(){"https://www.youtube.com/playlist"===url?(page="playlist",injectplaylist(!1)):page="https://www.youtube.com/watch"===url?"video":null}start(),chrome.runtime.onMessage.addListener((e,t,l)=>{let{type:r,data:i}=e;"exportplay"===r?"playlist"!=page?alert("This page is not a playlist"):exportPlay():"scroll"===r?"playlist"!=page?alert("This page is not a playlist"):document.getElementById("scrollb").click():"import"===r?"video"!=page?alert("This page is not a video"):(!0!=importing&&savePlaylist(i.name),importing=!0):"update"===r?(document.getElementById("scrollb").setAttribute("auto",i.auto),title=i.title):"count"===r&&l({text:document.querySelectorAll('a[id="video-title"]').length.toString(),scroll:document.getElementById("scrollb").getAttribute("scroll")})});